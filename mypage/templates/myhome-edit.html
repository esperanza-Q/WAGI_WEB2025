{% extends 'base.html' %}
{% load static %}

{% block title %}SujeongBridge - 프로필 수정{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'css/myhome-edit.css' %}">
{% endblock %}

{% block content %}
    <div class="container">

      <section class="profile-edit-wrapper">
        <h2 class="profile-edit-title">프로필 수정</h2>

        <!-- 프로필 수정 form -->
        <form class="profile-edit-form" id="profileEditForm" method="POST" enctype="multipart/form-data">
          {% csrf_token %}

          <!-- 프로필 이미지 -->
          <div class="profile-image-box">
            <img
              class="profile-image"
              id="profilePreview"
              src="{{ user.profileImage.url }}"
              alt="profile"
            >
            <button type="button" class="profile-image-edit-btn" id="imageEditBtn">✎</button>

            <!-- 실제 파일 input (숨김) -->
            <input 
              type="file"
              accept="image/*"
              id="profileImageInput"
              name="profileImage"
              style="display: none;"
            >
          </div>

          <div class="profile-edit-row">
            <div class="profile-edit-field">
              <div class="profile-edit-label">학번</div>
              <input type="text" class="profile-edit-input" value="{{request.user.username}}" disabled>
            </div>

            <div class="profile-edit-field">
              <div class="profile-edit-label">이메일</div>
              <input type="email" class="profile-edit-input" value="{{request.user.email}}" disabled>
            </div>
          </div>

          <div class="profile-edit-row">
            <div class="profile-edit-field">
              <div class="profile-edit-label">닉네임</div>
              <input type="text" class="profile-edit-input" name="new_nickname" value="{{request.user.display_name}}">
            </div>

            <div class="profile-edit-field">
              <div class="profile-edit-label">학년</div>
              <select name="new_grade" class="profile-edit-input">
                <option value="1" {% if selected_grade == "1" %}selected{% endif %}>1학년</option>
                <option value="2" {% if selected_grade == "2" %}selected{% endif %}>2학년</option>
                <option value="3" {% if selected_grade == "3" %}selected{% endif %}>3학년</option>
                <option value="4" {% if selected_grade == "4" %}selected{% endif %}>4학년</option>
                <option value="5" {% if selected_grade == "5" %}selected{% endif %}>휴학</option>
                <option value="6" {% if selected_grade == "6" %}selected{% endif %}>졸업생</option>
              </select>
            </div>
          </div>

          <div class="profile-edit-row">
            <div class="profile-edit-field">
              <div class="profile-edit-label">단과대</div>
              <select id="new_collegeSelect" class="profile-edit-input" name="new_college">
                <option value="" disabled {% if not selected_college %}selected{% endif %}>단과대 선택</option>
                <option value="NUR" {% if selected_college == "NUR" %}selected{% endif %}>간호대학</option>
                <option value="ENG" {% if selected_college == "ENG" %}selected{% endif %}>공과대학</option>
                <option value="ART" {% if selected_college == "ART" %}selected{% endif %}>미술대학</option>
                <option value="LAW" {% if selected_college == "LAW" %}selected{% endif %}>법과대학</option>
                <option value="EDU" {% if selected_college == "EDU" %}selected{% endif %}>사범대학</option>
                <option value="SOC" {% if selected_college == "SOC" %}selected{% endif %}>사회과학대학</option>
                <option value="LIF" {% if selected_college == "LIF" %}selected{% endif %}>생활산업대학</option>
                <option value="MUS" {% if selected_college == "MUS" %}selected{% endif %}>음악대학</option>
                <option value="HUMA" {% if selected_college == "HUMA" %}selected{% endif %}>인문융합예술대학</option>
                <option value="NAT" {% if selected_college == "NAT" %}selected{% endif %}>자연과학대학</option>
              </select>
            </div>

            <div class="profile-edit-field">
              <div class="profile-edit-label">학과</div>
              <select id="new_deptSelect" name="new_deptSelect" class="profile-edit-input">
                <option value="" disabled selected>학과 선택</option>
              </select>
            </div>
          </div>

          <button type="submit" class="profile-edit-submit-btn">
            수정 완료
          </button>
        </form>
      </section>

    </div>
{% endblock %}

{% block scripts %}
  <script>
    // JS (연동 전 동작용)
    // 이미지 편집 / 미리보기 코드는 주석 처리 상태로 유지
    // 학과 선택 API 연동 스크립트
    document.addEventListener("DOMContentLoaded", () => {
      const collegeSelect = document.getElementById("new_collegeSelect");
      const deptSelect = document.getElementById("new_deptSelect");
      const form = document.querySelector("form");

      if (!collegeSelect || !deptSelect) return;

      function resetDept(message = "학과 선택") {
        deptSelect.innerHTML = `<option value="" disabled selected>${message}</option>`;
        deptSelect.disabled = true;
      }

      collegeSelect.addEventListener("change", async () => {
        const collegeCode = collegeSelect.value;
        resetDept("불러오는 중...");
        if (!collegeCode) return;

        try {
          const url = `/accounts/api/departments/?college_id=${encodeURIComponent(collegeCode)}`;
          const res = await fetch(url);
          const data = await res.json();
          const departments = Array.isArray(data.departments) ? data.departments : [];

          if (departments.length === 0) {
            resetDept("해당 단과대 학과가 없습니다");
            return;
          }

          deptSelect.disabled = false;
          deptSelect.innerHTML = `<option value="" disabled selected>학과 선택</option>`;

          departments.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d.dept_id;
            opt.textContent = d.dept_name;
            deptSelect.appendChild(opt);
          });
        } catch (e) {
          console.error("학과 목록 불러오기 실패:", e);
          resetDept("학과 목록을 불러오지 못했습니다");
        }
      });

      resetDept();

      if (form) {
        form.addEventListener("submit", () => {
          deptSelect.disabled = false;
        });
      }
    });

    
    const editBtn = document.getElementById("imageEditBtn");
    const fileInput = document.getElementById("profileImageInput");
    const previewImg = document.getElementById("profilePreview");

    // ✎ 버튼 → 파일 선택창 열기
    editBtn.addEventListener("click", () => {
      fileInput.click();
    });

    // 파일 선택 → 미리보기 변경
    fileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  </script>
{% endblock %}

